@model Inspinia_MVC5_SeedProject.Models.AspNetUser

@{
    ViewBag.Title = Model.Email ;
}

@* replaced email by name *@
<input type="hidden" value="@ViewBag.id" id="userId" />
@*<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
        <h2>Profile</h2>
        <ol class="breadcrumb">
            <li class="active">
                <strong>Profile</strong>
            </li>
            
        </ol>
    </div>
</div>*@

@*<div data-bind="foreach:showProfile">
    <div data-bind="text:UserName">

    </div>
    <div data-bind="text:Email"></div>
    <form action="#">
        <input type="file" />
        <input type="submit" />
    </form>
</div>*@

<div class="wrapper wrapper-content animated fadeInRight" id="profile" >
    <div data-bind="with:showProfile">
        <div class="row m-b-lg m-t-lg">
            <div class="col-sm-5">

                <div class="profile-image">
                    <a target="_blank" data-bind="attr:{href:dpLink}">
                        <img data-bind="attr:{src:dpLink}" class="img-circle circle-border m-b-md" alt="profile">
                    </a>
                </div>
                <div class="profile-info">
                    <div class="">
                        <div>
                            <h2 class="no-margins" data-bind="text:name"></h2>(<span data-bind="text:isOnline"></span> @*<span data-bind="if:isOnline()"><i class="fa fa-circle text-navy"></i> online</span>
                                <span data-bind="if:!isOnline()"><i class="fa fa-circle text-warning"></i> offline</span>*@)
                            <br />
                            <small>
                                <button class="btn btn-sm" data-bind="visible: loginUserId != id,click:function(){ return addFriend(id)} " style="margin-bottom:1px"><span data-bind="visible:!isFriend()">Add Friend</span><span data-bind="visible:isFriend">UnFriend</span></button>
                                &nbsp;<button class="btn btn-sm" data-bind="visible: loginUserId != id,click:function(){ return sendMessage(id,name)}" style="margin-bottom:1px">Send message</button> &nbsp;<button data-bind="visible: loginUserId != id" style="margin-bottom:1px" class="btn btn-sm">Follow</button>
                                <a class="btn btn-sm btn-default" data-bind="visible: loginUserId == id,attr:{href:'/User/Profile/'+ id}" style="margin-bottom:1px">Edit Profile</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-3">
                <table class="table small m-b-xs">
                    <tbody>
                        <tr>
                            <td>
                                From:  <strong data-bind="text:city"></strong>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Email: <span data-bind="visible:!hideEmail"> <strong data-bind="text:UserName"></strong></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                phone number:<span data-bind="visible:!hidePhoneNumber"> <strong data-bind="text:phoneNumber"></strong></span>
                            </td>

                        </tr>
                        <tr>
                            <td>
                                Date of birth:<span data-bind="visible:!hideDateOfBirth"><strong data-bind="text:dateOfBirth"></strong> </span> &nbsp; Gender: <strong data-bind="text:gender"></strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-offset-1 col-sm-3">
                @*<table class="table small m-b-xs">
                        <tbody>
                            <tr>
                                <td>
                                    <strong>142</strong> Active ads
                                </td>
                                <td>
                                    <strong>22</strong> Followers
                                </td>

                            </tr>
                            <tr>
                                <td>
                                    <strong>61</strong> saved ads
                                </td>
                                <td>
                                    <strong>54</strong> Pages
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>154</strong> Questions
                                </td>
                                <td>
                                    <strong>32</strong> Answers
                                </td>
                            </tr>
                        </tbody>
                    </table>*@
            </div>

        </div>

        <div class="row">

            <div class="col-sm-3">
                
                <div class="ibox hidden-xs" >
                    <div class="ibox-content">
                        <h3>About <span data-bind="text:name"> </span></h3>
                        <p data-bind="visible:!about">Apparently, this user prefers to keep an air of mystery about them.</p>
                        <p class="small" data-bind="text:about">
                            
                        </p>
                    </div>
                </div>

                @*<div class="ibox hidden-xs">
                    <div class="ibox-content">
                        <h3>Followers and friends</h3>
                        <p class="small">
                            If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't
                            anything embarrassing
                        </p>
                        <div class="user-friends">
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a3.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a1.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a2.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a4.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a5.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a6.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a7.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a8.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a2.jpg"></a>
                            <a href=""><img alt="image" class="img-circle" src="~/Images/a1.jpg"></a>
                        </div>
                    </div>
                </div>*@
                <div class="ibox hidden-xs" data-bind="visible:loginUserId == id">
                    <div class="ibox-title"><h5>Manage Alerts</h5></div>
                    <div class="ibox-content">
                        <p data-bind="visible:followingTags().length>0">
                            You are receiving notifications for following tags:
                            @*<ul class="tag-list" data-bind="foreach:followingTags" style="padding:0">
                                <li><a href=""><i class="fa fa-tag"></i>&nbsp; <span data-bind="text:name"></span> </a></li>
                            </ul>*@
                            <div class="small m-t-xs" data-bind="foreach:followingTags">
                                <a target="_blank" data-bind="attr:{href:'/Tag/' + name},text:name" class="btn btn-xs btn-white" > </a>
                            </div><br />
                        </p>
                        @*<span data-bind="foreach:followingTags">
                            <p>&nbsp;</p>
                        </span>*@
                        <p >Enter tags you want to follow and you will be notified when new ad containing your followed tags will be posted</p>
                        <p > Note: If you are already following a tag then it will be unfollowed</p>
                        <input id="select-tags-to-follow" data-bind="value:tagsToFollow" class="repositories" placeholder="Pick tags..." />
                        <p data-bind="visible:tagsToFollow().length > 0">Follow tags <span data-bind="text:tagsToFollow"></span> and if already followed then unfollow</p>
                        <button data-bind="click:followTagsBtn" class="btn btn-primary">Submit</button>
                        <div data-bind="text:followSummary"></div>
                    </div>
                </div>

                

            </div>

            <div class="col-lg-7 col-sm-9">
                <h4>Active ads (<span data-bind="text:activeads().length"></span>)</h4><hr />
                <div data-bind="foreach:activeads">
                    <div class="row">
                        <div class="ibox">
                            <div class="ibox-content product-box  fh-250">
                                <div class="media">
                                    <div class="pull-left hidden-xs">
                                        <div class="product-imitation">
                                            <div class="carouselContainer">
                                                <span id="gallery" data-gallery=""
                                                      data-bind="slick: images,
                slickOptions: { initialSlide:0},
                slickIndex: imageIndex">
                                                </span>
                                                <div data-bind="visible:images().length == 0"><h2><br /><br /><br /><br /> No Images<br /><br /><br /><br /><br /></h2></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="media-body">
                                        <div class="product-desc">
                                            <span class="product-price">
                                                <span data-bind="if:!isBidingAllowed">
                                                    <span data-bind="if:price">
                                                        <span data-bind="text:price"></span> <small style="font-size:13px" class="text-muted">Rs. <span data-bind="html:isNegotiable"></span></small>
                                                    </span>
                                                    <span data-bind="if:!price">Price on contact</span>
                                                </span>
                                                <span data-bind="if:isBidingAllowed">
                                                    <span data-bind="if:price">
                                                        <span data-bind="if:highestBid() == '-Infinity'">
                                                            <span data-bind="text:price"></span> <small style="font-size:13px" class="text-muted ">Rs. (Initial Bid) </small>
                                                        </span>
                                                        <span data-bind="ifnot:highestBid() == '-Infinity'">
                                                            <span data-bind="text:highestBid"></span> <small style="font-size:13px" class="text-muted ">Rs. (current Bid) </small>
                                                        </span>
                                                    </span>
                                                    <span data-bind="if:!price">
                                                        <span data-bind="if:highestBid() == '-Infinity'">
                                                            No Bit yet
                                                        </span>
                                                        <span data-bind="ifnot:highestBid() == '-Infinity'">
                                                            <span data-bind="text:highestBid"></span> <small style="font-size:13px" class="text-muted ">Rs. (current Bid) </small>
                                                        </span>
                                                    </span>
                                                </span>
                                            </span>
                                            <a href="#" class="product-name" data-bind="text:title,attr:{href:link}"> Product</a>



                                            <div class="small m-t-xs" data-bind="foreach:showTags">
                                                <a target="_blank" data-bind="attr:{href:'/Tag/' + name}"> <span class="btn btn-xs btn-white" data-bind="text:name"> </span></a>
                                            </div><br />
                                            <div class=" fh-50" data-bind="truncatedText: description, maxTextLength: 150"></div><br />
                                            <div class="pull-right"><i class="fa fa-clock-o"></i> <span data-bind="text:time"></span></div>
                                            <div class="" data-bind="with:adLocation">
                                                <span data-bind="with:cityName">@*<i class="fa fa-ballon"></i>*@ <b>From:</b></span>
                                                <span data-bind="if:popularPlace">
                                                    <span data-bind="text:popularPlace"></span>,
                                                </span>
                                                <span data-bind="text:cityName"></span>
                                            </div>

                                            <div class="m-t text-righ">

                                                <a data-bind="attr:{href:link}" class="btn btn-xs btn-outline btn-primary">Info <i class="fa fa-long-arrow-right"></i> </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div data-bind="visible:id == loginUserId">
                    <h4>Saved ads (<span data-bind="text:savedads().length"></span>) </h4><hr />
                    <div data-bind="foreach:savedads">
                        <div class="row">
                            <div class="ibox">
                                <div class="ibox-content product-box">
                                    <div class="media">
                                        <div class="pull-left hidden-xs">
                                            <div class="product-imitation">
                                                <div class="carouselContainer">
                                                    <span id="gallery" data-gallery=""
                                                          data-bind="slick: images,
                slickOptions: { initialSlide:0},
                slickIndex: imageIndex">
                                                    </span>
                                                    <div data-bind="visible:images().length == 0"><h2><br /><br /><br /><br /> No Images<br /><br /><br /><br /><br /></h2></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="media-body">
                                            <div class="product-desc">
                                                <span class="product-price">
                                                    <span data-bind="if:!isBidingAllowed">
                                                        <span data-bind="if:price">
                                                            <span data-bind="text:price"></span> <small style="font-size:13px" class="text-muted">Rs. <span data-bind="html:isNegotiable"></span></small>
                                                        </span>
                                                        <span data-bind="if:!price">Price on contact</span>
                                                    </span>
                                                    <span data-bind="if:isBidingAllowed">
                                                        <span data-bind="if:price">
                                                            <span data-bind="if:highestBid() == '-Infinity'">
                                                                <span data-bind="text:price"></span> <small style="font-size:13px" class="text-muted ">Rs. (Initial Bid) </small>
                                                            </span>
                                                            <span data-bind="ifnot:highestBid() == '-Infinity'">
                                                                <span data-bind="text:highestBid"></span> <small style="font-size:13px" class="text-muted ">Rs. (current Bid) </small>
                                                            </span>
                                                        </span>
                                                        <span data-bind="if:!price">
                                                            <span data-bind="if:highestBid() == '-Infinity'">
                                                                No Bit yet
                                                            </span>
                                                            <span data-bind="ifnot:highestBid() == '-Infinity'">
                                                                <span data-bind="text:highestBid"></span> <small style="font-size:13px" class="text-muted ">Rs. (current Bid) </small>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </span>
                                                <a href="#" class="product-name" data-bind="text:title,attr:{href:link}"> Product</a>



                                                <div class="small m-t-xs" data-bind="foreach:showTags">
                                                    <a target="_blank" data-bind="attr:{href:'/Tag/' + name},text:name" class="btn btn-xs btn-white"> </a>
                                                </div><br />
                                                <div data-bind="text:description"></div><br />
                                                <div class="pull-right"><i class="fa fa-clock-o"></i> <span data-bind="text:time"></span></div>
                                                <div class="" data-bind="with:adLocation">
                                                    <span data-bind="with:cityName">@*<i class="fa fa-ballon"></i>*@ <b>From:</b></span>
                                                    <span data-bind="if:popularPlace">
                                                        <span data-bind="text:popularPlace"></span>,
                                                    </span>
                                                    <span data-bind="text:cityName"></span>
                                                </div>

                                                <div class="m-t text-righ">

                                                    <a data-bind="attr:{href:link}" class="btn btn-xs btn-outline btn-primary">Info <i class="fa fa-long-arrow-right"></i> </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <h4>Notifications (<span data-bind="text:notificationads().length"></span>) </h4><hr />
                
                <div data-bind="foreach:notificationads">
                    <div data-bind="text:title"></div>
                </div>
            </div>
            

        </div>
    </div>
            @*<div class="ibox float-e-margins">
                <div class="ibox-title  back-change">
                    <h5>Image cropper <small>http://fengyuanchen.github.io/cropper/</small></h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li>
                                <a href="#">Config option 1</a>
                            </li>
                            <li>
                                <a href="#">Config option 2</a>
                            </li>
                        </ul>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <p>
                        Crop image
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="image-crop">
                                <img src="~/Images/p3.jpg">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Preview image</h4>
                            <div class="img-preview img-preview-sm"></div>
                            <h4>&nbsp;</h4>
                            <div class="btn-group">
                                <form action="/User/saveProfilePic" method="post" id="setProfilePic" enctype="multipart/form-data">
                                    <label title="Upload image file" for="inputImage" class="btn btn-primary">

                                        <input type="file" accept="image/*" name="file" id="inputImage" class="hide">
                                        Upload new image
                                        <input type="submit" style="visibility:hidden" />

                                    </label>
                                </form>
                                <button id="setProfilePicBtn" class="btn btn-primary">Set as profile picture</button>
                            </div>
                            <h4>Other options</h4>
                            <div class="btn-group">
                                <button class="btn btn-white" id="zoomIn" type="button">Zoom In</button>
                                <button class="btn btn-white" id="zoomOut" type="button">Zoom Out</button>
                                <button class="btn btn-white" id="rotateLeft" type="button">Rotate Left</button>
                                <button class="btn btn-white" id="rotateRight" type="button">Rotate Right</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>*@
        </div>
<style>
    .carouselContainer {
        overflow: hidden;
        //height:350px;
        margin: 0px;
        padding: 0px;
    }

    #gallery {
        margin: 0px;
        padding: 0px;
    }

    .product-imitation {
        margin: 0px;
        padding: 0px;
        width: 250px !important;
        height: 250px;
        /apply max-padding or default image;
    }

    .carouselContainer img {
        // height: 350px;
        width: 250px !important;
        height: 250px;
    }

    .showAds .ibox {
        height: 420px;
    }
    .product-price{
        top:0px;
    }
    
</style>
@section Styles {

    @Styles.Render("~/plugins/toastrStyles")
@Styles.Render("~/plugins/imagecropperStyles")
@Styles.Render("~/bundles/tagStyles")
@Styles.Render("~/scripts/selectizeStyles")
@Styles.Render("~/plugins/slickStyles")
@Styles.Render("~/plugins/slickThemeStyles")
}

@Html.Partial("/Views/Shared/_Chat.cshtml")
@Html.Partial("~/Views/Shared/_UserLogin.cshtml")

@section Scripts{
    @Scripts.Render("~/plugins/toastr")
@Scripts.Render("~/plugins/imagecropper")
@Scripts.Render("~/scripts/selectize")
@Scripts.Render("~/plugins/slick")
@Scripts.Render("~/plugins/truncate")
<script src="~/Scripts/jquery.timeago.js"></script>
<script src="~/Scripts/knockout-3.3.0.js"></script>
<script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
<script src="~/signalr/hubs"></script>
<script src="~/Scripts/app/chat.js"></script>
<script src="~/Scripts/UserLogin.js"></script>
<script src="~/Scripts/app/slick-knockout-binding.js"></script>
    <script>
        function Tag(data) {
            var self = this;
            data = data || {};
            self.id = data.id;
            self.name = data.name;
        }
        function Bid(data) {
            var self = this;
            data = data || {};
            self.price = data.price;
        }
        var imageUrls = [];
        function adImages(data, adId, imagesCount) {
            return "/Images/Ads/" + adId + '_' + imagesCount + data.imageExtension;
        }
        function Location(data) {
            var self = this;
            data = data || {};
            self.cityId = data.cityId;
            self.cityName = data.cityName;
            self.popularPlaceId = data.popularPlaceId;
            self.popularPlace = data.popularPlace;
            self.exectLocation = data.exectLocation;
        }
        function Ad(data) {
            var self = this;

            self.images = ko.observable();
            self.options = {};
            self.imageIndex = ko.observable(1);

            data = data || {};
            self.title = data.title;
            self.description = ko.observable(data.description);
            self.postedByName = data.postedByName;
            self.postedById = data.postedById;
            self.id = data.id;
            self.time = getTimeAgo(data.time);
            self.loginUserId = data.islogin || "";
            self.showMobileAd = ko.observableArray();
            self.isReported = ko.observable(data.isReported);
            self.reportedCount = ko.observable(data.reportedCount);
            self.showImages = ko.observable();
            self.views = data.views;
            self.price = data.price || "";
            self.link = "/MobilesTablets/Details/" + data.id;
            var loginUserId1 = getLoginUserId(self.loginUserId); //to access self.loginUserId outside this function
            //biding
            self.highestBid = ko.observable();
            self.showBidings = ko.observableArray();
            self.isBidingAllowed = false;
            self.placeBid = ko.observable(false);
            self.bidAmount = ko.observable();

            self.showTags = ko.observableArray();
            self.adLocation = ko.observable();
            self.sellerProfile = function () {
                window.location.href = "/User/Index/" + self.postedById;
            }
            if (data.location != null) {
                self.adLocation(new Location(data.location));
            }
            if (data.isNegotiable == "b") {
                self.isBidingAllowed = true;
            } else if (data.isNegotiable == "y") {
                self.isNegotiable = 'Negotiable';
            } else if (data.isNegotiable == "n") {
                self.isNegotiable = '<strike>Negotiable</strike>';
            }
            if (self.price == "") {
                self.isNegotiable = "";
            }
            if (data.bid != null) {
                var biding = $.map(data.bid, function (item) { return new Bid(item); });
                self.highestBid(Math.max.apply(Math, data.bid.map(function (o) { return o.price; })));
                //self.showBidings(biding);
            }
            if (data.adTags != null) {
                var tags = $.map(data.adTags, function (item) { return new Tag(item); });
                self.showTags(tags);
            }
            if (data.adImages) {
                var imagesCount = 1;
                var img = $.map(data.adImages, function (item, ia) { return adImages(item, data.id, imagesCount++); });
                self.showImages(img);
                self.images(img);
            }
            self.report = function (id, loginUserId) {
                if (loginUserId) {
                    $.ajax({
                        url: '/api/Electronic/reportAd?id=' + id,
                        dataType: "json",
                        contentType: "application/json",
                        cache: false,
                        type: 'POST',
                        success: function (data) {
                            self.isReported(true);
                            self.reportedCount(data);
                        },
                        error: function (xhr, status, error) {
                            var err = eval("(" + xhr.responseText + ")");
                            toastr.info(err.Message);
                        }
                    })
                } else {
                    toastr.info("You must be login to report this ad", "Na na!");
                }
            }
        }
        function profile(data) {
            var self = this;
            data = data || {};

            self.tagsToFollow = ko.observable("");
            self.followSummary = ko.observable();
            self.followTagsBtn = function () {
                if (self.tagsToFollow() == "") {
                    toastr.info("Please Enter the tags");
                    return;
                }
                self.followSummary("");
                $.ajax({
                    url: '/api/Tag/FollowTags?tags=' + self.tagsToFollow() + '&isUnfollowAllowed=' + true,
                    dataType: "json",
                    contentType: "application/json",
                    cache: false,
                    type: 'POST',
                    success: function (data) {
                        self.followSummary("Done! Refresh page to see changes");
                    },
                    error: function () {
                        toastr.error("Some error has occured. Please refresh page and try again", "Error!");
                    }
                });
            }

            self.savedads = ko.observableArray();
            self.activeads = ko.observableArray();
            self.notificationads = ko.observableArray();

            self.id = data.Id;
            self.followingTags = ko.observableArray();
            if (data.followingTags) {
                var tagsdata = $.map(data.followingTags, function (item) { return new Tag(item); });
                self.followingTags(tagsdata);
            }
            if (data.savedads) {
                var adData = $.map(data.savedads, function (item) { return new Ad(item); });
                self.savedads(adData);
            }
            if (data.activeads) {
                var adData = $.map(data.activeads, function (item) { return new Ad(item); });
                self.activeads(adData);
            }
            if (data.notificationads) {
                var adData = $.map(data.notificationads, function (item) { return new Ad(item); });
                self.notificationads(adData);
            }

            self.UserName = data.UserName;
            self.city = data.city;
            self.gender = data.gender;
            self.dateOfBirth = "";
            if (data.dateOfBirth != null) {
                self.dateOfBirth = data.dateOfBirth.split("T")[0];
            }
            self.name = data.Email;
            self.phoneNumber = data.phoneNumber;
            self.hideEmail = data.hideEmail;
            self.hidePhoneNumber = data.hidePhoneNumber;
            self.hideDateOfBirth = data.hideDateOfBirth;
            self.dpLink = '/Images/Users/p' + self.id + data.dpExtension;
            if (!data.dpExtension) {
                self.dpLink = '/Images/Users/default.jpg';
            }
            self.about = data.about;
            self.lastSeen = data.lastSeen;
            self.reputation = data.reputation;
            self.since = data.since;
            self.isFriend = ko.observable(data.isFriend);
            self.isFriendRequestSent = ko.observable(data.isFriendRequestSent);
            self.addFriend = function (id) {
                if (self.loginUserId) {
                    if (self.isFriend()) {
                        self.unFriend(id);
                    } else {
                        self.isFriend(true);
                        $.ajax({
                            url: '/api/User/AddFriend?id=' + id,
                            dataType: "json",
                            contentType: "application/json",
                            cache: false,
                            type: 'POST',
                            success: function (data) {
                                //self.isFriend(true);
                            },
                            error: function () {
                                self.isFriend(false);
                                toastr.error("failed to add friend. Please refresh page and try again", "Error");
                            }
                        })
                    }
                } else {
                    loginBtn();
                }
            }
            self.follow = function (id) {

            }
            self.unFriend = function (id) {
                self.isFriend(false);
                $.ajax({
                    url: '/api/User/UnFriend?id=' + id,
                    dataType: "json",
                    contentType: "application/json",
                    cache: false,
                    type: 'POST',
                    success: function (data) {
                        //self.isFriend(false);
                    },
                    error: function () {
                        self.isFriend(true);
                        toastr.error("failed to unFriend. Please refresh page and try again", "Error");
                    }
                })
            }

            self.sendMessage = function (id, name) {
                sendMessageTo(id);
                sendMessgeToName(name);
                $(".open-small-chat").trigger('click');

            }

            self.loginUserId = data.loginUserId || "";
            self.age = getAge(self.dateOfBirth);
            self.isUserOnline = function (id) {

            }
            function getAge(dateString) {
                var today = new Date();
                var birthDate = new Date(dateString);
                birthDate = new Date(Date.parse(birthDate, "MM/dd/yyyy"));
                var age = today.getFullYear() - birthDate.getFullYear();
                var m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }
            self.calculateAge = function () {
                self.dateOfBirth = new Date(self.dateOfBirth);
                var today = new Date();
                self.age = Math.floor((today - self.dateOfBirth) / (365.25 * 24 * 60 * 60 * 1000));
            }
            self.openProfile = function () {
                var userId = $("#userId").val();
                window.location.href = "/User/Profile/" + userId;
            }
        }
        
        function viewModel() {
            //CreateAlert();
            ChatViewModel();
            AccountViewModel();
            
            var self = this;
            self.followedTags = ko.observableArray();
            self.showProfile = ko.observable();
            
            self.openProfile = function () {
                var userId = $("#userId").val();
                window.location.href = "/User/Profile/" + userId;
            }
            
            //online users
            //var userId = $("#userId").val();
            //self.onlineUsersHub = $.connection.onlineUsers;
            //self.onlineUsers = ko.observableArray();
            //self.onlineUsersHub.client.showConnected = function (connectionId) {
            //    var mape = $.map(connectionId, function (item) { return item });
            //    self.onlineUsers(mape);
            //    console.log("hi i am here");
            //}
            
           

            self.loadProfile = function () {
                var userId = $("#userId").val();
                $.ajax({
                    url: '/api/User/GetUser/' + userId,
                    dataType: "json",
                    contentType: "application/json",
                    cache: false,
                    type: 'GET',
                    success: function (data) {
                        self.showProfile(new profile(data));
                        $('#select-tags-to-follow').selectize({
                            valueField: 'name',
                            labelField: 'name',
                            searchField: 'name',
                            options: [],
                            maxItems: 20,
                            render: {
                                option: function (item, escape) {
                                    return '<div>' +
                                        '<span class="title">' +
                                            '<span class="name">' + escape(item.name) + '</span>' +

                                        '</span>' +
                                        '<span class="description">' + escape(item.info) + '</span>' +
                                        '<ul class="meta">' +
                                            '<li class="watchers"><span>' + escape(item.followers) + '</span> followers</li>' +
                                            '<li class="forks"><span>' + escape(item.questions) + '</span> times used</li>' +
                                        '</ul>' +
                                    '</div>';
                                }
                            },
                            load: function (query, callback) {
                                if (!query.length) return callback();
                                $.ajax({
                                    url: '/api/Tag/SearchTags?s=' + encodeURIComponent(query),
                                    type: 'POST',
                                    error: function () {
                                        callback();
                                    },
                                    success: function (res) {
                                        callback(res.slice(0, 10));
                                    }
                                });
                            }
                        });
                    },
                    error: function () {
                        toastr.error("failed to load profile", "Error");
                    }
                })
            }
            self.loadProfile();
            return self;
        }
        ko.bindingHandlers.truncatedText = {
            update: function (element, valueAccessor, allBindingsAccessor) {
                var originalText = ko.utils.unwrapObservable(valueAccessor()),
                    // 10 is a default maximum length
                    length = ko.utils.unwrapObservable(allBindingsAccessor().maxTextLength) || 20,
                    truncatedText = originalText.length > length ? originalText.substring(0, length) + " ..." : originalText;
                // updating text binding handler to show truncatedText
                ko.bindingHandlers.text.update(element, function () {
                    return truncatedText;
                });
            }
        };
        function getTimeAgo(varDate) {
            if (varDate) {
                return $.timeago(varDate.toString().slice(-1) == 'Z' ? varDate : varDate + 'Z');
            }
            else {
                return '';
            }
        }
        $(function () {
            
           


            $('#setProfilePicBtn').prop('disabled', true);
            var $image = $(".image-crop > img")
            $($image).cropper({
                aspectRatio: 1.618,
                preview: ".img-preview",
                done: function (data) {
                    //toastr.info("fone");
                    $('#setProfilePicBtn').prop('disabled', false);
                }
            });

            var $inputImage = $("#inputImage");
            if (window.FileReader) {
                $inputImage.change(function () {
                    var fileReader = new FileReader(),
                            files = this.files,
                            file;

                    if (!files.length) {
                        return;
                    }

                    file = files[0];

                    if (/^image\/\w+$/.test(file.type)) {
                        fileReader.readAsDataURL(file);
                        fileReader.onload = function () {
                            $inputImage.val("");
                            $image.cropper("reset", true).cropper("replace", this.result);
                        };
                    } else {
                        showMessage("Please choose an image file.");
                    }
                });
            } else {
                $inputImage.addClass("hide");
            }

            $("#setProfilePicBtn").click(function () {
                //window.open($image.cropper("getDataURL"));
                $("#setProfilePic").submit();
                toastr.info("Your profile picture is changed successfully! Please refresh page to see changes");
            });

            $("#zoomIn").click(function () {
                $image.cropper("zoom", 0.1);
            });

            $("#zoomOut").click(function () {
                $image.cropper("zoom", -0.1);
            });

            $("#rotateLeft").click(function () {
                $image.cropper("rotate", 45);
            });

            $("#rotateRight").click(function () {
                $image.cropper("rotate", -45);
            });

            $("#setDrag").click(function () {
                $image.cropper("setDragMode", "crop");
            });
            $.connection.hub.start().done();
            
            ko.applyBindings(new viewModel());
            
        });
    </script>
}



